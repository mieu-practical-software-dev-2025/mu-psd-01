<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>みんなの献立アドバイザー</title>
  <!-- Vue.js CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Bootstrap CDN -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
</head>
<body>
  <div id="app" class="container my-4">
    <h2 class="mb-4">みんなの献立アドバイザー</h2>

    <!-- 食材入力 -->
    <div class="mb-3">
      <label for="ingredients" class="form-label">食材（カンマ区切り）:</label>
      <textarea id="ingredients" class="form-control" rows="3" v-model="ingredientsText"
        placeholder="例: 鶏肉, 玉ねぎ, じゃがいも"></textarea>
    </div>

    <!-- 予算入力 -->
    <div class="mb-3">
      <label for="budget" class="form-label">予算（円・任意）:</label>
      <input type="number" id="budget" class="form-control" v-model="budget" placeholder="500">
    </div>

    <!-- 実行ボタン -->
    <div class="mb-3">
      <button @click="generateMenu" class="btn btn-primary">献立を作成</button>
    </div>

    <!-- 結果表示 -->
    <div v-if="loading" class="alert alert-info">献立を生成中です...</div>
    <div v-if="error" class="alert alert-danger">{{ error }}</div>

    <div v-if="menu" class="mt-4">
      <h3>{{ menu.menu_title }}</h3>

      <div v-for="(dish, idx) in menu.dishes" :key="idx" class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">{{ dish.name }}</h5>
          <p><strong>材料:</strong> {{ dish.ingredients.join(", ") }}</p>
          <p><strong>手順:</strong></p>
          <ol>
            <li v-for="(step, i) in dish.steps" :key="i">{{ step }}</li>
          </ol>
          <p><strong>カロリー:</strong> {{ dish.calories }} kcal</p>
          <p>
            <strong>栄養素:</strong>
            たんぱく質 {{ dish.nutrition["たんぱく質"] }}g /
            脂質 {{ dish.nutrition["脂質"] }}g /
            炭水化物 {{ dish.nutrition["炭水化物"] }}g
          </p>
        </div>
      </div>

      <p><strong>合計カロリー:</strong> {{ menu.total_calories }} kcal</p>
      <p><em>{{ menu.notes }}</em></p>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          ingredientsText: "",
          budget: "",
          menu: null,
          loading: false,
          error: null
        };
      },
      methods: {
        async generateMenu() {
          this.loading = true;
          this.error = null;
          this.menu = null;

          try {
            const ingredients = this.ingredientsText
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);

            const res = await fetch("/generate_menu", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                ingredients: ingredients,
                budget: this.budget ? parseInt(this.budget) : null
              })
            });

            const data = await res.json();
            if (!res.ok) {
              this.error = data.error || "不明なエラーが発生しました。";
            } else {
              this.menu = data;
            }
          } catch (err) {
            this.error = "通信エラー: " + err.message;
          } finally {
            this.loading = false;
          }
        }
      }
    }).mount("#app");
  </script>
</body>
</html>